'use client';

import { useEffect, useState } from 'react';
import { Button } from '@/components/ui/button';
import { 
  Bell, 
  LogOut, 
  Home, 
  ClipboardList, 
  BarChart3, 
  Users, 
  MessageSquare, 
  CheckSquare, 
  Settings,
  Plus,
  Search
} from 'lucide-react';
import { 
  getUser, 
  removeToken, 
  removeUser, 
  authAPI, 
  jobdeskAPI,
  kpiAPI,
  todoAPI,
  chatAPI,
  notificationAPI,
  divisionAPI,
  userAPI,
  dailyLogAPI
} from '@/lib/api';
import { toast } from 'sonner';
import { initSocket, disconnectSocket } from '@/lib/socket-client';
import { Badge } from '@/components/ui/badge';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';

// Import page components
import DashboardHome from './pages/DashboardHome';
import JobdeskPage from './pages/JobdeskPage';
import KPIPage from './pages/KPIPage';
import DivisionPage from './pages/DivisionPage';
import ChatPage from './pages/ChatPage';
import TodoPage from './pages/TodoPage';
import SettingsPage from './pages/SettingsPage';

export default function DashboardApp({ setIsLoggedIn }) {\n  const [currentUser, setCurrentUser] = useState(null);\n  const [currentPage, setCurrentPage] = useState('home');\n  const [socket, setSocket] = useState(null);\n  const [notifications, setNotifications] = useState([]);\n  const [showNotifications, setShowNotifications] = useState(false);\n  const [showJobdeskModal, setShowJobdeskModal] = useState(false);\n  const [hasJobdesks, setHasJobdesks] = useState(false);\n  const [checkingJobdesks, setCheckingJobdesks] = useState(true);\n\n  useEffect(() => {\n    const user = getUser();\n    setCurrentUser(user);\n\n    // Fetch current user info\n    authAPI.getMe().then(userData => {\n      setCurrentUser(userData);\n    }).catch(err => {\n      console.error('Failed to fetch user:', err);\n    });\n\n    // Initialize Socket.io\n    const socketInstance = initSocket();\n    if (socketInstance) {\n      setSocket(socketInstance);\n\n      // Listen for notifications\n      socketInstance.on('notification', (notification) => {\n        setNotifications(prev => [notification, ...prev]);\n        toast.info(notification.title, { description: notification.message });\n      });\n    }\n\n    // Fetch initial notifications\n    notificationAPI.getAll().then(data => {\n      setNotifications(data.notifications || []);\n    }).catch(err => {\n      console.error('Failed to fetch notifications:', err);\n    });\n\n    // Check if user has jobdesks (for karyawan)\n    if (user && user.role === 'karyawan') {\n      jobdeskAPI.getAll().then(data => {\n        const jobdesks = data.jobdesks || [];\n        setHasJobdesks(jobdesks.length > 0);\n        setCheckingJobdesks(false);\n        if (jobdesks.length === 0) {\n          setShowJobdeskModal(true);\n        }\n      }).catch(err => {\n        console.error('Failed to check jobdesks:', err);\n        setCheckingJobdesks(false);\n      });\n    } else {\n      setCheckingJobdesks(false);\n    }\n\n    return () => {\n      disconnectSocket();\n    };\n  }, []);\n\n  const handleLogout = () => {\n    removeToken();\n    removeUser();\n    disconnectSocket();\n    setIsLoggedIn(false);\n    toast.success('Logout berhasil');\n  };\n\n  const unreadCount = notifications.filter(n => !n.read).length;\n\n  const menuItems = [\n    { id: 'home', label: 'Dashboard', icon: Home, roles: ['super_admin', 'pengurus', 'sdm', 'karyawan'] },\n    { id: 'jobdesk', label: 'Jobdesk', icon: ClipboardList, roles: ['super_admin', 'pengurus', 'sdm', 'karyawan'] },\n    { id: 'kpi', label: 'KPI', icon: BarChart3, roles: ['super_admin', 'pengurus', 'sdm', 'karyawan'] },\n    { id: 'divisions', label: 'Divisi', icon: Users, roles: ['super_admin', 'pengurus', 'sdm'] },\n    { id: 'chat', label: 'Chat', icon: MessageSquare, roles: ['super_admin', 'pengurus', 'sdm', 'karyawan'] },\n    { id: 'todo', label: 'To-Do List', icon: CheckSquare, roles: ['super_admin', 'pengurus', 'sdm', 'karyawan'] },\n    { id: 'settings', label: 'Pengaturan', icon: Settings, roles: ['super_admin', 'pengurus', 'sdm', 'karyawan'] },\n  ];\n\n  const filteredMenuItems = currentUser \n    ? menuItems.filter(item => item.roles.includes(currentUser.role))\n    : [];\n\n  const renderPage = () => {\n    switch (currentPage) {\n      case 'home':\n        return <DashboardHome user={currentUser} />;\n      case 'jobdesk':\n        return <JobdeskPage user={currentUser} />;\n      case 'kpi':\n        return <KPIPage user={currentUser} />;\n      case 'divisions':\n        return <DivisionPage user={currentUser} />;\n      case 'chat':\n        return <ChatPage user={currentUser} socket={socket} />;\n      case 'todo':\n        return <TodoPage user={currentUser} />;\n      case 'settings':\n        return <SettingsPage user={currentUser} />;\n      default:\n        return <DashboardHome user={currentUser} />;\n    }\n  };\n\n  const getRoleBadgeColor = (role) => {\n    switch (role) {\n      case 'super_admin': return 'bg-purple-100 text-purple-800';\n      case 'pengurus': return 'bg-blue-100 text-blue-800';\n      case 'sdm': return 'bg-green-100 text-green-800';\n      case 'karyawan': return 'bg-gray-100 text-gray-800';\n      default: return 'bg-gray-100 text-gray-800';\n    }\n  };\n\n  const getRoleLabel = (role) => {\n    switch (role) {\n      case 'super_admin': return 'Super Admin';\n      case 'pengurus': return 'Pengurus';\n      case 'sdm': return 'SDM';\n      case 'karyawan': return 'Karyawan';\n      default: return role;\n    }\n  };\n\n  if (!currentUser || checkingJobdesks) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 flex items-center justify-center\">\n        <div className=\"animate-pulse text-gray-600\">Memuat...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      {/* Top Navbar */}\n      <header className=\"bg-white border-b border-gray-200 sticky top-0 z-50\">\n        <div className=\"px-4 sm:px-6 lg:px-8\">\n          <div className=\"flex justify-between items-center h-16\">\n            {/* Logo & Title */}\n            <div className=\"flex items-center space-x-4\">\n              <div className=\"flex items-center space-x-2\">\n                <div className=\"w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-400 rounded-lg flex items-center justify-center\">\n                  <Users className=\"w-6 h-6 text-white\" />\n                </div>\n                <div>\n                  <h1 className=\"text-xl font-bold text-gray-900\">Workspace</h1>\n                  <p className=\"text-xs text-gray-500\">Sistem Kolaborasi</p>\n                </div>\n              </div>\n            </div>\n\n            {/* Navigation Menu */}\n            <nav className=\"hidden md:flex items-center space-x-1\">\n              {filteredMenuItems.map(item => {\n                const Icon = item.icon;\n                return (\n                  <Button\n                    key={item.id}\n                    variant={currentPage === item.id ? 'default' : 'ghost'}\n                    size=\"sm\"\n                    onClick={() => setCurrentPage(item.id)}\n                    className=\"flex items-center space-x-2\"\n                  >\n                    <Icon className=\"w-4 h-4\" />\n                    <span>{item.label}</span>\n                  </Button>\n                );\n              })}\n            </nav>\n\n            {/* Right Side */}\n            <div className=\"flex items-center space-x-3\">\n              {/* Notifications */}\n              <DropdownMenu open={showNotifications} onOpenChange={setShowNotifications}>\n                <DropdownMenuTrigger asChild>\n                  <Button variant=\"ghost\" size=\"icon\" className=\"relative\">\n                    <Bell className=\"w-5 h-5\" />\n                    {unreadCount > 0 && (\n                      <span className=\"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center\">\n                        {unreadCount}\n                      </span>\n                    )}\n                  </Button>\n                </DropdownMenuTrigger>\n                <DropdownMenuContent align=\"end\" className=\"w-80\">\n                  <DropdownMenuLabel>Notifikasi</DropdownMenuLabel>\n                  <DropdownMenuSeparator />\n                  <div className=\"max-h-96 overflow-y-auto\">\n                    {notifications.length === 0 ? (\n                      <div className=\"p-4 text-center text-sm text-gray-500\">\n                        Tidak ada notifikasi\n                      </div>\n                    ) : (\n                      notifications.slice(0, 10).map(notif => (\n                        <DropdownMenuItem\n                          key={notif.id}\n                          className=\"flex flex-col items-start p-3 cursor-pointer\"\n                          onClick={() => {\n                            if (!notif.read) {\n                              notificationAPI.markAsRead(notif.id).catch(err => {\n                                console.error('Failed to mark as read:', err);\n                              });\n                              setNotifications(prev => \n                                prev.map(n => n.id === notif.id ? { ...n, read: true } : n)\n                              );\n                            }\n                          }}\n                        >\n                          <div className=\"flex items-start justify-between w-full\">\n                            <p className=\"font-semibold text-sm\">{notif.title}</p>\n                            {!notif.read && (\n                              <div className=\"w-2 h-2 bg-blue-600 rounded-full mt-1\" />\n                            )}\n                          </div>\n                          <p className=\"text-xs text-gray-600 mt-1\">{notif.message}</p>\n                          <p className=\"text-xs text-gray-400 mt-1\">\n                            {new Date(notif.createdAt).toLocaleString('id-ID')}\n                          </p>\n                        </DropdownMenuItem>\n                      ))\n                    )}\n                  </div>\n                </DropdownMenuContent>\n              </DropdownMenu>\n\n              {/* User Menu */}\n              <DropdownMenu>\n                <DropdownMenuTrigger asChild>\n                  <Button variant=\"ghost\" className=\"flex items-center space-x-2\">\n                    <Avatar className=\"w-8 h-8\">\n                      <AvatarFallback className=\"bg-blue-600 text-white\">\n                        {currentUser.name?.charAt(0).toUpperCase() || 'U'}\n                      </AvatarFallback>\n                    </Avatar>\n                    <div className=\"hidden lg:block text-left\">\n                      <p className=\"text-sm font-medium\">{currentUser.name}</p>\n                      <Badge className={`text-xs ${getRoleBadgeColor(currentUser.role)}`}>\n                        {getRoleLabel(currentUser.role)}\n                      </Badge>\n                    </div>\n                  </Button>\n                </DropdownMenuTrigger>\n                <DropdownMenuContent align=\"end\">\n                  <DropdownMenuLabel>\n                    <div>\n                      <p className=\"font-semibold\">{currentUser.name}</p>\n                      <p className=\"text-xs text-gray-500\">{currentUser.email}</p>\n                    </div>\n                  </DropdownMenuLabel>\n                  <DropdownMenuSeparator />\n                  <DropdownMenuItem onClick={() => setCurrentPage('settings')}>\n                    <Settings className=\"w-4 h-4 mr-2\" />\n                    Pengaturan\n                  </DropdownMenuItem>\n                  <DropdownMenuItem onClick={handleLogout} className=\"text-red-600\">\n                    <LogOut className=\"w-4 h-4 mr-2\" />\n                    Logout\n                  </DropdownMenuItem>\n                </DropdownMenuContent>\n              </DropdownMenu>\n            </div>\n          </div>\n        </div>\n      </header>\n\n      {/* Main Content */}\n      <main className=\"p-4 sm:p-6 lg:p-8\">\n        {renderPage()}\n      </main>\n\n      {/* Jobdesk Modal untuk Karyawan */}\n      {currentUser.role === 'karyawan' && (\n        <Dialog open={showJobdeskModal} onOpenChange={setShowJobdeskModal}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Selamat Datang!</DialogTitle>\n              <DialogDescription>\n                Anda belum memiliki jobdesk. Silakan hubungi pengurus atau admin untuk mendapatkan jobdesk Anda.\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"flex justify-end space-x-2 mt-4\">\n              <Button onClick={() => setShowJobdeskModal(false)}>\n                Mengerti\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n      )}\n\n      {/* Mobile Navigation */}\n      <div className=\"md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-2\">\n        <div className=\"flex justify-around\">\n          {filteredMenuItems.slice(0, 5).map(item => {\n            const Icon = item.icon;\n            return (\n              <Button\n                key={item.id}\n                variant={currentPage === item.id ? 'default' : 'ghost'}\n                size=\"sm\"\n                onClick={() => setCurrentPage(item.id)}\n                className=\"flex flex-col items-center space-y-1 h-auto py-2\"\n              >\n                <Icon className=\"w-5 h-5\" />\n                <span className=\"text-xs\">{item.label}</span>\n              </Button>\n            );\n          })}\n        </div>\n      </div>\n    </div>\n  );\n}
